<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件格式转换工具 - 支持多种文档格式互转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 文件处理库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-parse/1.1.1/pdf-parse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rtf-parser@1.0.0/rtf-parser.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .format-card {
                @apply relative bg-white rounded-xl p-4 shadow-md transition-all duration-300 hover:shadow-lg cursor-pointer border-2 border-transparent;
            }
            .format-card-selected {
                @apply border-primary bg-blue-50;
            }
            .format-card-disabled {
                @apply opacity-50 cursor-not-allowed;
            }
            .format-card-supported {
                @apply relative;
            }
            .format-card-supported::after {
                content: "推荐";
                @apply absolute -top-1 -right-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded;
            }
            .gradient-bg {
                @apply bg-gradient-to-br from-primary to-accent;
            }
            .glass-effect {
                @apply bg-white/80 backdrop-blur-md;
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .progress-animation {
                transition: width 0.5s ease-in-out;
            }
            .drop-area-active {
                @apply border-primary bg-blue-50;
            }
            .file-error {
                @apply border-red-500 bg-red-50;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 导航栏 -->
    <header class="glass-effect sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-exchange text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">文件格式转换工具</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-gray-700 hover:text-primary transition-colors">首页</a>
                <a href="#" class="text-gray-700 hover:text-primary transition-colors">支持的格式</a>
                <a href="#" class="text-gray-700 hover:text-primary transition-colors">使用教程</a>
                <a href="#" class="text-gray-700 hover:text-primary transition-colors">关于我们</a>
            </nav>
            <button class="md:hidden text-gray-700" id="menuToggle">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t animate-fadeIn">
            <div class="container mx-auto px-4 py-3 flex flex-col space-y-3">
                <a href="#" class="text-gray-700 hover:text-primary py-2 transition-colors">首页</a>
                <a href="#" class="text-gray-700 hover:text-primary py-2 transition-colors">支持的格式</a>
                <a href="#" class="text-gray-700 hover:text-primary py-2 transition-colors">使用教程</a>
                <a href="#" class="text-gray-700 hover:text-primary py-2 transition-colors">关于我们</a>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 介绍部分 -->
        <section class="text-center mb-12 max-w-3xl mx-auto">
            <h2 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold mb-4">简单高效的文件格式转换</h2>
            <p class="text-gray-600 text-lg mb-6">支持 DOC, DOCX, XLS, XLSX, PDF 等多种格式互转，操作简单，转换快速</p>
            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">DOCX</span>
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">XLSX</span>
                <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">PDF</span>
                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">TXT</span>
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">CSV</span>
            </div>
        </section>

        <!-- 转换流程区 -->
        <section class="max-w-5xl mx-auto">
            <!-- 步骤指示器 -->
            <div class="flex justify-between items-center mb-10 relative">
                <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -translate-y-1/2 z-0"></div>
                <div class="absolute top-1/2 left-0 h-1 gradient-bg -translate-y-1/2 z-10 transition-all duration-500 progress-animation" id="progressBar" style="width: 25%"></div>
                
                <div class="relative z-20 flex flex-col items-center" id="step1Indicator">
                    <div class="w-10 h-10 rounded-full gradient-bg text-white flex items-center justify-center mb-2">
                        <i class="fa fa-file-o"></i>
                    </div>
                    <span class="text-sm font-medium">选择输入格式</span>
                </div>
                
                <div class="relative z-20 flex flex-col items-center" id="step2Indicator">
                    <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mb-2 transition-all duration-300">
                        <i class="fa fa-exchange"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-500 transition-all duration-300">选择输出格式</span>
                </div>
                
                <div class="relative z-20 flex flex-col items-center" id="step3Indicator">
                    <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mb-2 transition-all duration-300">
                        <i class="fa fa-upload"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-500 transition-all duration-300">上传文件</span>
                </div>
                
                <div class="relative z-20 flex flex-col items-center" id="step4Indicator">
                    <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mb-2 transition-all duration-300">
                        <i class="fa fa-download"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-500 transition-all duration-300">下载结果</span>
                </div>
            </div>

            <!-- 已选格式提示区 -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-6 hidden" id="selectionSummary">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-500 mr-2">输入格式:</span>
                            <span id="inputFormatDisplay" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"></span>
                        </div>
                        <i class="fa fa-long-arrow-right text-gray-400"></i>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-500 mr-2">输出格式:</span>
                            <span id="outputFormatDisplay" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium"></span>
                        </div>
                    </div>
                    <button id="changeFormats" class="text-sm text-primary hover:text-primary/80 transition-colors hidden md:flex items-center">
                        <i class="fa fa-pencil mr-1"></i> 更改
                    </button>
                </div>
            </div>

            <!-- 步骤内容区 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <!-- 步骤1: 选择输入格式 -->
                <div id="step1" class="step-content">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center mr-3">1</span>
                        选择输入文件格式
                    </h3>
                    
                    <p class="text-gray-600 mb-6">请选择您要转换的文件的原始格式：</p>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="inputFormats">
                        <!-- 格式卡片将通过JS动态生成 -->
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-100 rounded-lg">
                        <div class="flex items-start">
                            <i class="fa fa-info-circle text-primary mt-0.5 mr-3"></i>
                            <p class="text-sm text-gray-700">提示：选择正确的输入格式可以确保转换效果更佳。文件格式可通过文件名后缀判断（如.docx、.pdf）。</p>
                        </div>
                    </div>
                </div>
                
                <!-- 步骤2: 选择输出格式 -->
                <div id="step2" class="step-content hidden">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center mr-3">2</span>
                        选择目标文件格式
                    </h3>
                    
                    <p class="text-gray-600 mb-6">请选择您想要转换到的目标格式（标"推荐"的格式转换效果更佳）：</p>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="outputFormats">
                        <!-- 格式卡片将通过JS动态生成 -->
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-100 rounded-lg">
                        <div class="flex items-start">
                            <i class="fa fa-lightbulb-o text-primary mt-0.5 mr-3"></i>
                            <p class="text-sm text-gray-700">提示：仅显示与 <span id="currentInputFormatHint" class="font-medium"></span> 兼容的转换格式。复杂格式转换可能导致部分样式丢失。</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button id="backToStep1" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-arrow-left mr-2"></i> 返回
                        </button>
                        <button id="toStep3" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            下一步 <i class="fa fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 步骤3: 上传文件 -->
                <div id="step3" class="step-content hidden">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center mr-3">3</span>
                        上传您的文件
                    </h3>
                    
                    <!-- 文件选择错误提示 -->
                    <div id="fileSelectError" class="p-4 bg-red-50 border border-red-100 rounded-lg mb-6 hidden">
                        <div class="flex items-start">
                            <i class="fa fa-exclamation-circle text-red-500 mt-0.5 mr-3"></i>
                            <p class="text-sm text-red-700" id="fileErrorText">请选择一个有效的文件</p>
                        </div>
                    </div>
                    
                    <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center hover:border-primary transition-colors mb-6 cursor-pointer">
                        <i class="fa fa-cloud-upload text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">拖放文件到此处，或点击选择文件</p>
                        <p class="text-gray-400 text-sm">支持最大文件大小：100MB</p>
                        <input type="file" id="fileInput" class="hidden" accept="" />
                        <button id="browseFiles" class="mt-4 px-5 py-2 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity">
                            选择文件
                        </button>
                    </div>
                    
                    <div id="filePreview" class="hidden mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg flex items-center">
                            <i class="fa fa-file-text-o text-2xl text-primary mr-4"></i>
                            <div class="flex-grow">
                                <p id="fileName" class="font-medium"></p>
                                <p id="fileSize" class="text-sm text-gray-500"></p>
                            </div>
                            <button id="removeFile" class="text-gray-400 hover:text-red-500 transition-colors">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-yellow-50 border border-yellow-100 rounded-lg mb-6">
                        <div class="flex items-start">
                            <i class="fa fa-exclamation-circle text-yellow-500 mt-0.5 mr-3"></i>
                            <p class="text-sm text-gray-700">请上传 <span id="fileTypeHint" class="font-medium"></span> 格式的文件。上传的文件将被安全处理，转换完成后自动删除，不会被保存。</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button id="backToStep2" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-arrow-left mr-2"></i> 返回
                        </button>
                        <button id="startConversion" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            开始转换 <i class="fa fa-cog ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 步骤4: 转换结果 -->
                <div id="step4" class="step-content hidden">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center mr-3">4</span>
                        转换完成
                    </h3>
                    
                    <div id="conversionSuccess" class="text-center py-8">
                        <div class="w-20 h-20 rounded-full bg-green-100 text-green-500 flex items-center justify-center mx-auto mb-6 pulse-animation">
                            <i class="fa fa-check text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold mb-2">转换成功！</h4>
                        <p class="text-gray-600 mb-6">您的文件已成功从 <span id="fromFormatText" class="font-medium"></span> 转换为 <span id="toFormatText" class="font-medium"></span></p>
                        
                        <div class="bg-gray-50 p-4 rounded-lg flex items-center max-w-md mx-auto mb-8">
                            <i class="fa fa-file-text-o text-2xl text-primary mr-4"></i>
                            <div class="flex-grow">
                                <p id="convertedFileName" class="font-medium"></p>
                                <p id="convertedFileSize" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                        
                        <button id="downloadFile" class="px-8 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center mx-auto">
                            <i class="fa fa-download mr-2"></i> 下载文件
                        </button>
                    </div>

                    <!-- 转换失败提示 -->
                    <div id="conversionFailed" class="text-center py-8 hidden">
                        <div class="w-20 h-20 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-times text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold mb-2 text-red-600">转换失败</h4>
                        <p class="text-gray-600 mb-6" id="failureReason">该格式转换暂时不支持，请尝试其他格式组合</p>
                        
                        <button id="retryConversion" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity">
                            重新尝试
                        </button>
                    </div>
                    
                    <div class="p-4 bg-green-50 border border-green-100 rounded-lg mt-8">
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-0.5 mr-3"></i>
                            <p class="text-sm text-gray-700">提示：下载链接将在24小时后失效。如果需要再次转换，可以点击下方按钮重新开始。</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button id="convertAnother" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            转换另一个文件
                        </button>
                    </div>
                </div>
                
                <!-- 转换中状态 -->
                <div id="converting" class="step-content hidden text-center py-10">
                    <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-6"></div>
                    <h4 class="text-xl font-bold mb-2">正在转换文件...</h4>
                    <p class="text-gray-600 mb-4" id="conversionStatus">正在准备转换...</p>
                    <div class="mt-6 w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                        <div id="conversionProgress" class="gradient-bg h-2.5 rounded-full progress-animation" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">
                        转换进度: <span id="progressPercentage">0%</span>
                    </p>
                </div>
            </div>
        </section>
        
        <!-- 支持的格式说明 -->
        <section class="mt-16 max-w-5xl mx-auto">
            <h3 class="text-2xl font-bold mb-6 text-center">支持的文件格式及转换能力</h3>
            
            <div class="overflow-x-auto mb-8">
                <table class="w-full border-collapse bg-white rounded-xl shadow-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="py-3 px-4 text-left font-bold text-gray-700">源格式</th>
                            <th class="py-3 px-4 text-left font-bold text-gray-700">可转换为</th>
                            <th class="py-3 px-4 text-left font-bold text-gray-700">转换效果</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">DOC/DOCX (Word)</td>
                            <td class="py-3 px-4">PDF, TXT, HTML, RTF</td>
                            <td class="py-3 px-4"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">优秀</span></td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">XLS/XLSX (Excel)</td>
                            <td class="py-3 px-4">PDF, CSV, TXT</td>
                            <td class="py-3 px-4"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">优秀</span></td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">PDF</td>
                            <td class="py-3 px-4">TXT, HTML</td>
                            <td class="py-3 px-4"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">良好</span>（纯文本优先）</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">TXT/HTML/RTF</td>
                            <td class="py-3 px-4">PDF, DOCX, 相互转换</td>
                            <td class="py-3 px-4"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">优秀</span></td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium">CSV</td>
                            <td class="py-3 px-4">XLSX, PDF, TXT</td>
                            <td class="py-3 px-4"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">优秀</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-16">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fa fa-exchange text-primary text-xl"></i>
                        <h3 class="text-lg font-bold">文件格式转换工具</h3>
                    </div>
                    <p class="text-gray-400 text-sm">简单、高效、安全的在线文件格式转换工具，支持多种文档格式互转。</p>
                </div>
                
                <div>
                    <h4 class="font-bold mb-4">快速链接</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-primary transition-colors">首页</a></li>
                        <li><a href="#" class="hover:text-primary transition-colors">支持的格式</a></li>
                        <li><a href="#" class="hover:text-primary transition-colors">使用教程</a></li>
                        <li><a href="#" class="hover:text-primary transition-colors">常见问题</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-bold mb-4">联系我们</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li class="flex items-center"><i class="fa fa-envelope-o mr-2"></i> support@example.com</li>
                        <li class="flex items-center"><i class="fa fa-phone mr-2"></i> +123 456 7890</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-bold mb-4">关注我们</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center hover:bg-primary transition-colors">
                            <i class="fa fa-facebook"></i>
                        </a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center hover:bg-primary transition-colors">
                            <i class="fa fa-twitter"></i>
                        </a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center hover:bg-primary transition-colors">
                            <i class="fa fa-instagram"></i>
                        </a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center hover:bg-primary transition-colors">
                            <i class="fa fa-linkedin"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-500 text-sm">
                <p>&copy; 2023 文件格式转换工具 - 保留所有权利</p>
            </div>
        </div>
    </footer>

    <script>
        // 格式数据及其转换关系
        const formatData = {
            // 文档格式
            'doc': { 
                name: 'Word 文档', 
                icon: 'fa-file-word-o', 
                color: 'text-blue-600',
                canConvertTo: ['docx', 'txt', 'html', 'rtf', 'pdf'],
                supported: { 'docx': true, 'pdf': true, 'txt': true }
            },
            'docx': { 
                name: 'Word 文档', 
                icon: 'fa-file-word-o', 
                color: 'text-blue-600',
                canConvertTo: ['doc', 'txt', 'html', 'rtf', 'pdf'],
                supported: { 'pdf': true, 'txt': true, 'html': true }
            },
            'txt': { 
                name: '文本文件', 
                icon: 'fa-file-text-o', 
                color: 'text-gray-600',
                canConvertTo: ['doc', 'docx', 'html', 'rtf', 'pdf'],
                supported: { 'docx': true, 'pdf': true, 'html': true }
            },
            'html': { 
                name: '网页文件', 
                icon: 'fa-file-code-o', 
                color: 'text-orange-600',
                canConvertTo: ['doc', 'docx', 'txt', 'rtf', 'pdf'],
                supported: { 'docx': true, 'pdf': true, 'txt': true }
            },
            'rtf': { 
                name: '富文本', 
                icon: 'fa-file-text-o', 
                color: 'text-purple-600',
                canConvertTo: ['doc', 'docx', 'txt', 'html', 'pdf'],
                supported: { 'docx': true, 'txt': true }
            },
            
            // 表格格式
            'xls': { 
                name: 'Excel 表格', 
                icon: 'fa-file-excel-o', 
                color: 'text-green-600',
                canConvertTo: ['xlsx', 'csv', 'pdf', 'txt'],
                supported: { 'xlsx': true, 'csv': true, 'pdf': true }
            },
            'xlsx': { 
                name: 'Excel 表格', 
                icon: 'fa-file-excel-o', 
                color: 'text-green-600',
                canConvertTo: ['xls', 'csv', 'pdf', 'txt'],
                supported: { 'csv': true, 'pdf': true, 'txt': true }
            },
            'csv': { 
                name: '逗号分隔值', 
                icon: 'fa-file-text-o', 
                color: 'text-yellow-600',
                canConvertTo: ['xls', 'xlsx', 'pdf', 'txt'],
                supported: { 'xlsx': true, 'pdf': true }
            },
            
            // 其他格式
            'pdf': { 
                name: 'PDF 文档', 
                icon: 'fa-file-pdf-o', 
                color: 'text-red-600',
                canConvertTo: ['txt', 'html', 'docx'],
                supported: { 'txt': true, 'html': true }
            }
        };

        // 存储用户选择的格式和文件
        let selectedInputFormat = null;
        let selectedOutputFormat = null;
        let uploadedFile = null;
        let convertedFile = null;
        
        // DOM 元素
        const inputFormatsContainer = document.getElementById('inputFormats');
        const outputFormatsContainer = document.getElementById('outputFormats');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const converting = document.getElementById('converting');
        const progressBar = document.getElementById('progressBar');
        const conversionProgress = document.getElementById('conversionProgress');
        const progressPercentage = document.getElementById('progressPercentage');
        const conversionStatus = document.getElementById('conversionStatus');
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const browseFilesBtn = document.getElementById('browseFiles');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFile');
        const fromFormatText = document.getElementById('fromFormatText');
        const toFormatText = document.getElementById('toFormatText');
        const convertedFileName = document.getElementById('convertedFileName');
        const convertedFileSize = document.getElementById('convertedFileSize');
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const selectionSummary = document.getElementById('selectionSummary');
        const inputFormatDisplay = document.getElementById('inputFormatDisplay');
        const outputFormatDisplay = document.getElementById('outputFormatDisplay');
        const changeFormatsBtn = document.getElementById('changeFormats');
        const currentInputFormatHint = document.getElementById('currentInputFormatHint');
        const fileTypeHint = document.getElementById('fileTypeHint');
        const toStep3Btn = document.getElementById('toStep3');
        const startConversionBtn = document.getElementById('startConversion');
        const conversionSuccess = document.getElementById('conversionSuccess');
        const conversionFailed = document.getElementById('conversionFailed');
        const failureReason = document.getElementById('failureReason');
        const retryConversionBtn = document.getElementById('retryConversion');
        const fileSelectError = document.getElementById('fileSelectError');
        const fileErrorText = document.getElementById('fileErrorText');
        
        // 步骤指示器元素
        const stepIndicators = [
            document.getElementById('step1Indicator'),
            document.getElementById('step2Indicator'),
            document.getElementById('step3Indicator'),
            document.getElementById('step4Indicator')
        ];

        // 初始化输入格式选择界面
        function initInputFormats() {
            inputFormatsContainer.innerHTML = '';
            
            // 按类别分组显示格式
            const docFormats = ['doc', 'docx', 'txt', 'html', 'rtf'];
            const sheetFormats = ['xls', 'xlsx', 'csv'];
            const otherFormats = ['pdf'];
            
            // 添加分组标题
            addFormatGroup('文档格式', docFormats);
            addFormatGroup('表格格式', sheetFormats);
            addFormatGroup('其他格式', otherFormats);
        }
        
        // 添加格式分组
        function addFormatGroup(title, formats) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'col-span-full';
            
            const titleDiv = document.createElement('h4');
            titleDiv.className = 'text-sm font-medium text-gray-500 mb-3';
            titleDiv.textContent = title;
            groupDiv.appendChild(titleDiv);
            
            const formatsGrid = document.createElement('div');
            formatsGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3';
            
            formats.forEach(format => {
                const formatInfo = formatData[format];
                const formatCard = createFormatCard(format, formatInfo, true);
                formatsGrid.appendChild(formatCard);
            });
            
            groupDiv.appendChild(formatsGrid);
            inputFormatsContainer.appendChild(groupDiv);
        }
        
        // 创建格式选择卡片
        function createFormatCard(format, formatInfo, isInput) {
            const card = document.createElement('div');
            card.className = 'format-card';
            if (!isInput && formatInfo.supported && formatInfo.supported[format]) {
                card.classList.add('format-card-supported');
            }
            card.dataset.format = format;
            
            card.innerHTML = `
                <div class="flex flex-col items-center">
                    <i class="fa ${formatInfo.icon} ${formatInfo.color} text-2xl mb-2"></i>
                    <span class="font-medium text-sm">${format.toUpperCase()}</span>
                    <span class="text-xs text-gray-500 mt-1">${formatInfo.name}</span>
                </div>
            `;
            
            card.addEventListener('click', () => {
                if (isInput) {
                    // 处理输入格式选择
                    document.querySelectorAll('#inputFormats .format-card').forEach(el => {
                        el.classList.remove('format-card-selected');
                    });
                    card.classList.add('format-card-selected');
                    selectedInputFormat = format;
                    
                    // 更新输入格式显示
                    inputFormatDisplay.textContent = format.toUpperCase();
                    
                    // 生成输出格式选项
                    generateOutputFormats();
                    
                    // 切换到步骤2
                    goToStep(2);
                } else {
                    // 处理输出格式选择
                    document.querySelectorAll('#outputFormats .format-card').forEach(el => {
                        el.classList.remove('format-card-selected');
                    });
                    card.classList.add('format-card-selected');
                    selectedOutputFormat = format;
                    
                    // 更新输出格式显示
                    outputFormatDisplay.textContent = format.toUpperCase();
                    
                    // 启用下一步按钮
                    toStep3Btn.disabled = false;
                }
            });
            
            return card;
        }
        
        // 生成输出格式选项
        function generateOutputFormats() {
            outputFormatsContainer.innerHTML = '';
            
            if (!selectedInputFormat) return;
            
            // 更新当前输入格式提示
            currentInputFormatHint.textContent = selectedInputFormat.toUpperCase();
            
            const targetFormats = formatData[selectedInputFormat].canConvertTo;
            const inputFormatInfo = formatData[selectedInputFormat];
            
            targetFormats.forEach(format => {
                const formatInfo = {
                    ...formatData[format],
                    supported: inputFormatInfo.supported
                };
                const formatCard = createFormatCard(format, formatInfo, false);
                outputFormatsContainer.appendChild(formatCard);
            });
            
            // 显示选择摘要
            selectionSummary.classList.remove('hidden');
        }
        
        // 切换到指定步骤
        function goToStep(stepNumber) {
            // 隐藏所有步骤
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // 隐藏文件选择错误提示
            fileSelectError.classList.add('hidden');
            dropArea.classList.remove('file-error');
            
            // 更新进度条
            progressBar.style.width = `${(stepNumber - 1) * 25}%`;
            
            // 更新步骤指示器
            stepIndicators.forEach((indicator, index) => {
                const circle = indicator.querySelector('div');
                const text = indicator.querySelector('span');
                
                if (index < stepNumber) {
                    // 已完成步骤
                    circle.className = 'w-10 h-10 rounded-full gradient-bg text-white flex items-center justify-center mb-2';
                    text.className = 'text-sm font-medium';
                } else if (index === stepNumber - 1) {
                    // 当前步骤
                    circle.className = 'w-10 h-10 rounded-full gradient-bg text-white flex items-center justify-center mb-2';
                    text.className = 'text-sm font-medium';
                } else {
                    // 未完成步骤
                    circle.className = 'w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mb-2';
                    text.className = 'text-sm font-medium text-gray-500';
                }
            });
            
            // 显示当前步骤
            switch(stepNumber) {
                case 1:
                    step1.classList.remove('hidden');
                    // 隐藏选择摘要
                    selectionSummary.classList.add('hidden');
                    break;
                case 2:
                    step2.classList.remove('hidden');
                    // 显示选择摘要
                    selectionSummary.classList.remove('hidden');
                    // 重置输出格式选择状态
                    selectedOutputFormat = null;
                    outputFormatDisplay.textContent = '';
                    toStep3Btn.disabled = true;
                    break;
                case 3:
                    step3.classList.remove('hidden');
                    // 显示选择摘要
                    selectionSummary.classList.remove('hidden');
                    // 确保已选择输入格式
                    if (selectedInputFormat) {
                        // 设置文件选择器接受的格式
                        fileInput.accept = `.${selectedInputFormat}`;
                        // 更新文件类型提示
                        fileTypeHint.textContent = selectedInputFormat.toUpperCase();
                    }
                    // 重置文件上传区域
                    fileInput.value = '';
                    filePreview.classList.add('hidden');
                    startConversionBtn.disabled = true;
                    uploadedFile = null;
                    break;
                case 4:
                    step4.classList.remove('hidden');
                    // 显示选择摘要
                    selectionSummary.classList.remove('hidden');
                    break;
            }
        }
        
        // 执行实际文件转换
        async function convertFile() {
            if (!uploadedFile || !selectedInputFormat || !selectedOutputFormat) return;
            
            // 显示转换中状态
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });
            converting.classList.remove('hidden');
            
            // 重置进度
            conversionProgress.style.width = '0%';
            progressPercentage.textContent = '0%';
            
            try {
                // 读取文件内容
                updateConversionProgress(10, "正在读取文件内容...");
                const fileContent = await readFileContent(uploadedFile);
                
                // 根据格式类型进行转换
                updateConversionProgress(25, "正在准备转换引擎...");
                
                let result = null;
                let mimeType = '';
                const baseName = uploadedFile.name.replace(/\.[^/.]+$/, "");
                const outputFileName = `${baseName}.${selectedOutputFormat}`;

                // Word格式处理
                if (['doc', 'docx'].includes(selectedInputFormat)) {
                    result = await handleWordConversion(fileContent, uploadedFile, selectedOutputFormat);
                    mimeType = getMimeType(selectedOutputFormat);
                }
                // 表格格式处理
                else if (['xls', 'xlsx', 'csv'].includes(selectedInputFormat)) {
                    result = await handleSpreadsheetConversion(fileContent, uploadedFile, selectedInputFormat, selectedOutputFormat);
                    mimeType = getMimeType(selectedOutputFormat);
                }
                // PDF格式处理
                else if (selectedInputFormat === 'pdf') {
                    result = await handlePDFConversion(fileContent, selectedOutputFormat);
                    mimeType = getMimeType(selectedOutputFormat);
                }
                // 文本格式处理
                else if (['txt', 'html', 'rtf'].includes(selectedInputFormat)) {
                    result = await handleTextConversion(fileContent, selectedInputFormat, selectedOutputFormat);
                    mimeType = getMimeType(selectedOutputFormat);
                }
                
                // 验证转换结果
                if (!result) {
                    throw new Error(`暂不支持 ${selectedInputFormat.toUpperCase()} 转 ${selectedOutputFormat.toUpperCase()} 的转换`);
                }
                
                updateConversionProgress(90, "正在验证文件完整性...");
                
                // 创建转换后的文件
                let blob;
                if (result instanceof Blob) {
                    blob = result;
                } else if (typeof result === 'string') {
                    blob = new Blob([result], { type: mimeType });
                } else if (result instanceof ArrayBuffer) {
                    blob = new Blob([result], { type: mimeType });
                } else {
                    throw new Error("转换结果格式不正确");
                }
                
                convertedFile = new File([blob], outputFileName, { type: mimeType });
                updateConversionProgress(100, "转换完成，准备下载...");
                
                // 转换完成，进入步骤4（显示成功）
                setTimeout(() => {
                    goToStep(4);
                    conversionSuccess.classList.remove('hidden');
                    conversionFailed.classList.add('hidden');
                    // 更新结果信息
                    fromFormatText.textContent = selectedInputFormat.toUpperCase();
                    toFormatText.textContent = selectedOutputFormat.toUpperCase();
                    convertedFileName.textContent = convertedFile.name;
                    convertedFileSize.textContent = formatFileSize(convertedFile.size);
                }, 800);
            } catch (error) {
                console.error("转换错误:", error);
                // 显示失败信息
                setTimeout(() => {
                    goToStep(4);
                    conversionSuccess.classList.add('hidden');
                    conversionFailed.classList.remove('hidden');
                    failureReason.textContent = error.message || "转换过程中发生错误，请重试或尝试其他格式";
                }, 500);
            }
        }

        // Word格式转换处理
        async function handleWordConversion(content, file, outputFormat) {
            // 处理DOCX转其他格式
            if (outputFormat === 'txt' || outputFormat === 'html') {
                // 使用mammoth库提取Word内容
                const result = await mammoth.extractRawText({arrayBuffer: content});
                if (outputFormat === 'html') {
                    const htmlResult = await mammoth.convertToHtml({arrayBuffer: content});
                    return htmlResult.value;
                }
                return result.value;
            }
            // 转PDF
            else if (outputFormat === 'pdf') {
                const result = await mammoth.extractRawText({arrayBuffer: content});
                const textContent = result.value;
                
                // 创建PDF文档
                const pdfDoc = await PDFLib.PDFDocument.create();
                const fontBytes = await fetch('https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2').then(res => res.arrayBuffer());
                const robotoFont = await pdfDoc.embedFont(fontBytes);
                const page = pdfDoc.addPage([600, 800]);
                
                // 处理分页
                const fontSize = 12;
                const lineHeight = 15;
                const margin = 50;
                let yPosition = 750;
                const lines = textContent.split('\n');
                
                for (const line of lines) {
                    if (yPosition < margin + lineHeight) {
                        page = pdfDoc.addPage([600, 800]);
                        yPosition = 750;
                    }
                    page.drawText(line, {x: margin, y: yPosition, font: robotoFont, size: fontSize});
                    yPosition -= lineHeight;
                }
                
                return await pdfDoc.save();
            }
            // 转RTF
            else if (outputFormat === 'rtf') {
                const result = await mammoth.extractRawText({arrayBuffer: content});
                return `{\\rtf1\\ansi\\deff0\n${result.value}\n}`;
            }
            // 转DOC（简单处理）
            else if (outputFormat === 'doc') {
                return content; // 实际需专用库，此处简化
            }
            return null;
        }

        // 表格格式转换处理
        async function handleSpreadsheetConversion(content, file, inputFormat, outputFormat) {
            // 使用SheetJS处理电子表格
            const workbook = XLSX.read(content, { 
                type: inputFormat === 'csv' ? 'string' : 'array',
                cellDates: true,
                cellStyles: true
            });
            
            // 转换为其他表格格式
            if (['xls', 'xlsx', 'csv'].includes(outputFormat)) {
                const outputType = outputFormat === 'csv' ? 'csv' : 
                                  (outputFormat === 'xls' ? 'binary' : 'array');
                return XLSX.write(workbook, { 
                    bookType: outputFormat, 
                    type: outputType,
                    cellStyles: true,
                    sheetStubs: true
                });
            }
            // 转换为PDF
            else if (outputFormat === 'pdf') {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const fontBytes = await fetch('https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2').then(res => res.arrayBuffer());
                const robotoFont = await pdfDoc.embedFont(fontBytes);
                
                // 处理所有工作表
                for (const sheetName of workbook.SheetNames) {
                    const worksheet = workbook.Sheets[sheetName];
                    const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                    
                    // 创建表格数据
                    const tableData = [];
                    for (let row = range.s.r; row <= range.e.r; row++) {
                        const rowData = [];
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            const cell = worksheet[cellAddress];
                            rowData.push(cell ? cell.v : '');
                        }
                        tableData.push(rowData);
                    }
                    
                    // 添加页面
                    const page = pdfDoc.addPage([800, 600]);
                    page.drawText(`工作表: ${sheetName}`, {
                        x: 50,
                        y: 550,
                        font: robotoFont,
                        size: 14,
                    });
                    
                    // 绘制表格
                    let yPos = 520;
                    const rowHeight = 25;
                    const colWidth = 100;
                    
                    tableData.forEach((row, rowIdx) => {
                        // 表头样式
                        const isHeader = rowIdx === 0;
                        const textColor = isHeader ? PDFLib.rgb(1, 1, 1) : PDFLib.rgb(0, 0, 0);
                        const bgColor = isHeader ? PDFLib.rgb(0.2, 0.4, 0.8) : PDFLib.rgb(1, 1, 1);
                        
                        // 绘制行背景
                        if (isHeader) {
                            page.drawRectangle({
                                x: 50,
                                y: yPos - rowHeight + 5,
                                width: colWidth * row.length,
                                height: rowHeight,
                                color: bgColor
                            });
                        }
                        
                        row.forEach((cell, colIdx) => {
                            page.drawText(cell.toString(), {
                                x: 50 + (colIdx * colWidth) + 5,
                                y: yPos,
                                font: robotoFont,
                                size: 10,
                                color: textColor
                            });
                        });
                        
                        yPos -= rowHeight;
                        // 分页处理
                        if (yPos < 50) {
                            yPos = 520;
                            page = pdfDoc.addPage([800, 600]);
                        }
                    });
                }
                
                return await pdfDoc.save();
            }
            // 转TXT
            else if (outputFormat === 'txt') {
                let text = '';
                for (const sheetName of workbook.SheetNames) {
                    text += `=== ${sheetName} ===\n`;
                    text += XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]) + '\n\n';
                }
                return text;
            }
            return null;
        }

        // PDF格式转换处理
        async function handlePDFConversion(content, outputFormat) {
            // PDF转文本
            if (outputFormat === 'txt') {
                const data = await pdfParse(content);
                return data.text;
            }
            // PDF转HTML
            else if (outputFormat === 'html') {
                const data = await pdfParse(content);
                return `<html><head><title>PDF转换结果</title></head><body>
                        <h1>PDF转换为HTML</h1>
                        <p>${data.text.replace(/\n/g, '<br>')}</p>
                        </body></html>`;
            }
            // PDF转DOCX（简化处理）
            else if (outputFormat === 'docx') {
                const data = await pdfParse(content);
                // 实际需专用库，此处生成简单DOCX（模拟）
                return new Blob([data.text], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            }
            return null;
        }

        // 文本格式转换处理
        async function handleTextConversion(content, inputFormat, outputFormat) {
            // 文本转PDF
            if (outputFormat === 'pdf') {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const fontBytes = await fetch('https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2').then(res => res.arrayBuffer());
                const robotoFont = await pdfDoc.embedFont(fontBytes);
                const page = pdfDoc.addPage([600, 800]);
                
                // 处理内容
                let textContent = content;
                if (inputFormat === 'html') {
                    const doc = new DOMParser().parseFromString(content, 'text/html');
                    textContent = doc.body.textContent || '';
                } else if (inputFormat === 'rtf') {
                    // 使用rtf-parser处理RTF
                    textContent = await new Promise((resolve) => {
                        rtfParser.parse(content, (err, result) => {
                            if (err) resolve(content);
                            else resolve(result.text);
                        });
                    });
                }
                
                // 绘制文本
                const fontSize = 12;
                const lineHeight = 15;
                const margin = 50;
                let yPosition = 750;
                const lines = textContent.split('\n');
                
                lines.forEach(line => {
                    if (yPosition < margin + lineHeight) {
                        page = pdfDoc.addPage([600, 800]);
                        yPosition = 750;
                    }
                    page.drawText(line, {x: margin, y: yPosition, font: robotoFont, size: fontSize});
                    yPosition -= lineHeight;
                });
                
                return await pdfDoc.save();
            }
            // 文本转Word
            else if (outputFormat === 'docx') {
                // 实际需专用库，此处生成简单DOCX（模拟）
                return new Blob([content], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            }
            // 文本格式互转
            else {
                return convertTextFormat(content, inputFormat, outputFormat);
            }
        }
        
        // 更新转换进度
        function updateConversionProgress(percent, status) {
            conversionProgress.style.width = `${percent}%`;
            progressPercentage.textContent = `${percent}%`;
            conversionStatus.textContent = status;
        }
        
        // 处理文件下载
        function downloadConvertedFile() {
            if (!convertedFile) return;
            
            // 创建下载链接
            const url = URL.createObjectURL(convertedFile);
            const a = document.createElement('a');
            a.href = url;
            a.download = convertedFile.name;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // 读取文件内容
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.type.includes('text') || ['txt', 'html', 'rtf', 'csv'].includes(getExtension(file.name))) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
                
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error("无法读取文件内容，请检查文件是否损坏"));
            });
        }
        
        // 获取文件扩展名
        function getExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }
        
        // 获取MIME类型
        function getMimeType(format) {
            const mimeTypes = {
                'txt': 'text/plain',
                'html': 'text/html',
                'rtf': 'application/rtf',
                'pdf': 'application/pdf',
                'xls': 'application/vnd.ms-excel',
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'csv': 'text/csv',
                'doc': 'application/msword',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            };
            return mimeTypes[format] || 'application/octet-stream';
        }
        
        // 文本格式转换
        function convertTextFormat(content, fromFormat, toFormat) {
            if (fromFormat === toFormat) return content;
            
            // TXT转换
            if (toFormat === 'txt') {
                if (fromFormat === 'html') {
                    const doc = new DOMParser().parseFromString(content, 'text/html');
                    return doc.body.textContent || '';
                }
                if (fromFormat === 'rtf') {
                    return content.replace(/\\[a-z0-9]+/gi, '').replace(/\{|\}/g, '').trim();
                }
            }
            
            // HTML转换
            if (toFormat === 'html') {
                if (fromFormat === 'txt') {
                    return `<html><head><meta charset="UTF-8"></head><body><p>${content.replace(/\n/g, '<br>')}</p></body></html>`;
                }
                if (fromFormat === 'rtf') {
                    return `<html><head><meta charset="UTF-8"></head><body><p>${content.replace(/\\[a-z0-9]+/gi, '').replace(/\{|\}/g, '').replace(/\n/g, '<br>')}</p></body></html>`;
                }
            }
            
            // RTF转换
            if (toFormat === 'rtf') {
                return `{\\rtf1\\ansi\\deff0\n${content}\n}`;
            }
            
            return content;
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 显示文件选择错误
        function showFileError(message) {
            fileErrorText.textContent = message;
            fileSelectError.classList.remove('hidden');
            dropArea.classList.add('file-error');
        }
        
        // 处理文件上传
        function handleFileUpload(file) {
            // 隐藏之前的错误提示
            fileSelectError.classList.add('hidden');
            dropArea.classList.remove('file-error');
            
            if (!file) {
                showFileError("请选择一个文件");
                return;
            }
            
            // 验证文件格式
            const fileExtension = getExtension(file.name);
            if (fileExtension !== selectedInputFormat) {
                showFileError(`请上传${selectedInputFormat.toUpperCase()}格式的文件（当前文件格式为${fileExtension.toUpperCase()}）`);
                fileInput.value = '';
                return;
            }
            
            // 验证文件大小（最大100MB）
            if (file.size > 100 * 1024 * 1024) {
                showFileError('文件大小不能超过100MB');
                fileInput.value = '';
                return;
            }
            
            // 保存上传的文件
            uploadedFile = file;
            
            // 显示文件预览
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.classList.remove('hidden');
            
            // 启用转换按钮
            startConversionBtn.disabled = false;
        }
        
        // 事件监听器
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化输入格式
            initInputFormats();
            
            // 步骤导航按钮
            document.getElementById('backToStep1').addEventListener('click', () => goToStep(1));
            toStep3Btn.addEventListener('click', () => {
                if (selectedOutputFormat) {
                    goToStep(3);
                } else {
                    alert('请选择目标格式');
                }
            });
            document.getElementById('backToStep2').addEventListener('click', () => goToStep(2));
            startConversionBtn.addEventListener('click', convertFile);
            document.getElementById('convertAnother').addEventListener('click', () => {
                // 重置选择
                selectedInputFormat = null;
                selectedOutputFormat = null;
                uploadedFile = null;
                convertedFile = null;
                fileInput.value = '';
                filePreview.classList.add('hidden');
                initInputFormats();
                goToStep(1);
            });
            retryConversionBtn.addEventListener('click', () => {
                goToStep(3);
            });
            
            // 下载文件功能
            document.getElementById('downloadFile').addEventListener('click', downloadConvertedFile);
            
            // 更改格式按钮
            changeFormatsBtn.addEventListener('click', () => {
                goToStep(2);
            });
            
            // 文件上传相关
            browseFilesBtn.addEventListener('click', () => {
                // 确保文件输入框重置
                fileInput.value = '';
                // 触发点击
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                } else {
                    showFileError("未选择任何文件");
                }
            });
            
            removeFileBtn.addEventListener('click', () => {
                fileInput.value = '';
                filePreview.classList.add('hidden');
                startConversionBtn.disabled = true;
                uploadedFile = null;
                // 隐藏错误提示
                fileSelectError.classList.add('hidden');
                dropArea.classList.remove('file-error');
            });
            
            // 拖放功能增强
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.add('drop-area-active');
            });
            
            dropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.remove('drop-area-active');
            });
            
            dropArea.addEventListener('dragend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.remove('drop-area-active');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.remove('drop-area-active');
                
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                } else {
                    showFileError("未检测到可上传的文件");
                }
            });
            
            // 确保点击区域可以触发文件选择
            dropArea.addEventListener('click', (e) => {
                // 防止事件冒泡导致的问题
                e.stopPropagation();
                // 重置文件输入
                fileInput.value = '';
                // 触发文件选择
                fileInput.click();
            });
            
            // 移动端菜单
            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // 防止页面其他区域影响拖放
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>
