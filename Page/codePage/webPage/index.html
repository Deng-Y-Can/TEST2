<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candy网页代码实时预览工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入代码高亮和补全库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/html-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/css-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/javascript-lint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
    <!-- 引入ESLint用于JavaScript校验 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/eslint/7.32.0/eslint.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC',
                        code: '#282A36' // Dracula主题背景色
                    },
                    fontFamily: {
                        mono: ['Consolas', 'Monaco', 'monospace']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .editor-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }

            .preview-shadow {
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            }

            .console-line {
                @apply py-1 text-sm border-b border-gray-200 last:border-0;
            }

            .console-error {
                @apply text-red-500;
            }

            .console-log {
                @apply text-gray-800;
            }

            .console-info {
                @apply text-blue-500;
            }

            .console-warning {
                @apply text-yellow-600;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 标题区域 -->
        <header class="mb-8 text-center">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-dark mb-2">
                <i class="fa fa-code mr-2 text-primary"></i>Candy网页代码实时预览工具
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">
                支持代码错误校验、自动补全和控制台输出的多功能代码预览工具
            </p>
        </header>

        <!-- 主要内容区域 -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 代码编辑区域 -->
            <div class="space-y-6">
                <!-- HTML编辑器 -->
                <div class="editor-shadow rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg">
                    <div class="bg-primary text-white px-4 py-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-html5 mr-2"></i>
                            <h2 class="font-semibold">HTML</h2>
                            <span id="html-error-count" class="ml-2 text-xs bg-red-500 rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="hint-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="html">
                                <i class="fa fa-lightbulb-o mr-1"></i>提示
                            </button>
                            <button class="copy-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="html">
                                <i class="fa fa-copy mr-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="html-editor" class="hidden">&lt;div class="demo"&gt;
  &lt;h1&gt;Hello, World!&lt;/h1&gt;
  &lt;p&gt;这是一个演示文本&lt;/p&gt;
  &lt;button id="demo-btn"&gt;点击我&lt;/button&gt;
  &lt;input type="text" id="name-input" placeholder="输入你的名字" /&gt;
&lt;/div&gt;</textarea>
                        <div id="html-error-messages" class="text-red-500 text-xs p-2 bg-red-50 hidden"></div>
                    </div>
                </div>

                <!-- CSS编辑器 -->
                <div class="editor-shadow rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg">
                    <div class="bg-blue-600 text-white px-4 py-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-css3 mr-2"></i>
                            <h2 class="font-semibold">CSS</h2>
                            <span id="css-error-count" class="ml-2 text-xs bg-red-500 rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="hint-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="css">
                                <i class="fa fa-lightbulb-o mr-1"></i>提示
                            </button>
                            <button class="copy-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="css">
                                <i class="fa fa-copy mr-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="css-editor" class="hidden">.demo {
  text-align: center;
  padding: 2rem;
}

h1 {
  color: #3B82F6;
  font-size: 2rem;
  transition: color 0.3s;
}

p {
  color: #64748B;
  font-size: 1rem;
}

#demo-btn {
  background-color: #10B981;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.3s;
  margin: 10px;
}

#demo-btn:hover {
  background-color: #059669;
}

#name-input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 10px;
}</textarea>
                        <div id="css-error-messages" class="text-red-500 text-xs p-2 bg-red-50 hidden"></div>
                    </div>
                </div>

                <!-- JavaScript编辑器 -->
                <div class="editor-shadow rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg">
                    <div class="bg-yellow-500 text-white px-4 py-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-js mr-2"></i>
                            <h2 class="font-semibold">JavaScript</h2>
                            <span id="js-error-count" class="ml-2 text-xs bg-red-500 rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="hint-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="js">
                                <i class="fa fa-lightbulb-o mr-1"></i>提示
                            </button>
                            <button class="copy-btn text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors" data-target="js">
                                <i class="fa fa-copy mr-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="js-editor" class="hidden">// 点击按钮改变标题颜色
document.getElementById('demo-btn').addEventListener('click', function() {
  const heading = document.querySelector('h1');
  const nameInput = document.getElementById('name-input');
  const userName = nameInput.value || '访客';
  
  const colors = ['#3B82F6', '#10B981', '#EF4444', '#8B5CF6', '#F59E0B'];
  const randomColor = colors[Math.floor(Math.random() * colors.length)];
  
  heading.style.color = randomColor;
  heading.textContent = `Hello, ${userName}!`;
  
  // 控制台输出
  console.log('按钮被点击，标题已更新');
  console.info('当前标题颜色:', randomColor);
});

// 输入框事件
document.getElementById('name-input').addEventListener('input', function(e) {
  console.log('输入框内容变化:', e.target.value);
});

// 演示不同类型的控制台输出
console.log('页面加载完成');
console.info('这是一条信息提示');
console.warn('这是一条警告信息');
console.error('这是一条错误信息示例');</textarea>
                        <div id="js-error-messages" class="text-red-500 text-xs p-2 bg-red-50 hidden"></div>
                    </div>
                </div>

                <!-- 控制按钮 -->
                <div class="flex flex-wrap gap-4 pt-2">
                    <button id="run-btn" class="flex-1 bg-secondary hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fa fa-play mr-2"></i>运行代码
                    </button>
                    <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg transition-colors">
                        <i class="fa fa-trash mr-2"></i>清空
                    </button>
                    <button id="reset-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-3 px-6 rounded-lg transition-colors">
                        <i class="fa fa-refresh mr-2"></i>重置
                    </button>
                </div>
            </div>

            <!-- 预览和控制台区域 -->
            <div class="flex flex-col h-full space-y-6">
                <!-- 预览区域 -->
                <div class="editor-shadow rounded-lg overflow-hidden flex-1 flex flex-col transition-all duration-300 hover:shadow-lg">
                    <div class="bg-dark text-white px-4 py-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-desktop mr-2"></i>
                            <h2 class="font-semibold">预览效果</h2>
                        </div>
                        <div class="flex items-center">
                            <span id="preview-status" class="text-xs bg-gray-600 px-2 py-0.5 rounded"></span>
                        </div>
                    </div>
                    <div id="preview-container" class="flex-1 bg-white p-4 overflow-auto preview-shadow">
                        <div id="preview-area" class="w-full h-full min-h-[200px]"></div>
                    </div>
                </div>

                <!-- 控制台输出区域 -->
                <div class="editor-shadow rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg">
                    <div class="bg-code text-white px-4 py-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-terminal mr-2"></i>
                            <h2 class="font-semibold">控制台输出</h2>
                        </div>
                        <button id="clear-console" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded transition-colors">
                            <i class="fa fa-trash-o mr-1"></i>清空
                        </button>
                    </div>
                    <div id="console-output" class="h-48 bg-gray-50 overflow-y-auto p-2 text-sm font-mono">
                        <div class="console-line text-gray-500">控制台将显示代码运行时的输出信息...</div>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div id="status-message" class="mt-2 py-2 px-4 rounded-lg text-center hidden"></div>
            </div>
        </main>

        <!-- 功能说明 -->
        <div class="mt-10 bg-blue-50 border border-blue-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">工具功能说明</h3>
            <ul class="list-disc list-inside text-blue-700 space-y-2 text-sm">
                <li>代码错误实时校验：自动检测HTML、CSS和JavaScript代码中的语法错误</li>
                <li>自动补全提示：按下Ctrl+空格可触发代码提示，或点击"提示"按钮</li>
                <li>控制台输出：显示代码中的console.log、console.error等输出信息</li>
                <li>实时预览：代码修改后1秒自动更新预览，也可点击"运行代码"手动更新</li>
                <li>代码复制：每个编辑器都有复制按钮，可快速复制当前代码</li>
            </ul>
        </div>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>Candy网页代码实时预览工具 &copy; 2025</p>
        </footer>
    </div>

    <script>
        // 初始化代码编辑器
        let htmlEditor, cssEditor, jsEditor;
        let originalHtml, originalCss, originalJs;

        // 存储上一次注入的样式和脚本，用于清除
        let lastStyleElement = null;
        let lastScriptElement = null;
        let eventListeners = []; // 存储事件监听器以便清除

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 保存原始代码用于重置功能
            originalHtml = document.getElementById('html-editor').value;
            originalCss = document.getElementById('css-editor').value;
            originalJs = document.getElementById('js-editor').value;

            // 初始化HTML编辑器
            htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                smartIndent: true,
                autoCloseTags: true,
                matchTags: { bothTags: true },
                hintOptions: {
                    completeSingle: false
                },
                gutters: ["CodeMirror-lint-markers"],
                lint: true
            });

            // 初始化CSS编辑器
            cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
                mode: 'css',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                smartIndent: true,
                autoCloseBrackets: true,
                hintOptions: {
                    completeSingle: false
                },
                gutters: ["CodeMirror-lint-markers"],
                lint: true
            });

            // 初始化JavaScript编辑器
            jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
                mode: 'javascript',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                smartIndent: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                hintOptions: {
                    completeSingle: false
                },
                gutters: ["CodeMirror-lint-markers"],
                lint: true
            });

            // 设置编辑器高度
            const setEditorHeight = () => {
                const height = window.innerWidth >= 1024 ? '200px' : '150px';
                htmlEditor.setSize('100%', height);
                cssEditor.setSize('100%', height);
                jsEditor.setSize('100%', height);
            };

            setEditorHeight();
            window.addEventListener('resize', setEditorHeight);

            // 监听编辑器内容变化事件
            htmlEditor.on('change', handleEditorChange);
            cssEditor.on('change', handleEditorChange);
            jsEditor.on('change', handleEditorChange);

            // 监听Lint事件，显示错误数量
            htmlEditor.on('lint', (instance, annotations) => {
                updateErrorCount('html', annotations);
            });

            cssEditor.on('lint', (instance, annotations) => {
                updateErrorCount('css', annotations);
            });

            jsEditor.on('lint', (instance, annotations) => {
                updateErrorCount('js', annotations);
            });

            // 初始运行一次代码
            runCode();
        });

        // 处理编辑器内容变化
        let debounceTimer;
        function handleEditorChange() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runCode, 1000);
            document.getElementById('preview-status').textContent = '待更新...';
            document.getElementById('preview-status').className = 'text-xs bg-yellow-500 px-2 py-0.5 rounded';
        }

        // 更新错误计数显示
        function updateErrorCount(type, annotations) {
            const errorCount = annotations.filter(a => a.severity === 'error').length;
            const errorElement = document.getElementById(`${type}-error-count`);

            if (errorCount > 0) {
                errorElement.textContent = errorCount;
                errorElement.classList.remove('hidden');

                // 显示错误信息
                const errorMessagesElement = document.getElementById(`${type}-error-messages`);
                errorMessagesElement.innerHTML = annotations
                    .filter(a => a.severity === 'error')
                    .map(a => `${a.message} (行: ${a.from.line + 1})`)
                    .join('<br>');
                errorMessagesElement.classList.remove('hidden');
            } else {
                errorElement.classList.add('hidden');
                document.getElementById(`${type}-error-messages`).classList.add('hidden');
            }
        }

        // 添加控制台消息
        function addConsoleMessage(args, type) {
            const consoleOutput = document.getElementById('console-output');
            // 格式化消息
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return arg;
            }).join(' ');

            // 创建消息元素
            const time = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.className = `console-line console-${type}`;
            messageElement.innerHTML = `<span class="text-gray-500 mr-2">${time}</span>${message}`;

            // 添加到控制台
            if (consoleOutput.children[0].textContent.includes('将显示代码运行时的输出信息')) {
                consoleOutput.innerHTML = '';
            }
            consoleOutput.appendChild(messageElement);

            // 滚动到底部
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // 运行代码函数 - 修复JS执行和控制台输出问题
        function runCode() {
            try {
                // 清除上一次的样式、脚本和事件监听器
                if (lastStyleElement) {
                    lastStyleElement.remove();
                    lastStyleElement = null;
                }
                if (lastScriptElement) {
                    lastScriptElement.remove();
                    lastScriptElement = null;
                }
                // 移除之前添加的事件监听器
                eventListeners.forEach(({ element, event, listener }) => {
                    if (element && listener) {
                        element.removeEventListener(event, listener);
                    }
                });
                eventListeners = [];

                // 获取编辑器内容
                const htmlContent = htmlEditor.getValue();
                const cssContent = cssEditor.getValue();
                const jsContent = jsEditor.getValue();

                // 设置HTML内容
                const previewArea = document.getElementById('preview-area');
                previewArea.innerHTML = htmlContent;

                // 添加CSS样式
                const styleElement = document.createElement('style');
                styleElement.textContent = cssContent;
                previewArea.appendChild(styleElement);
                lastStyleElement = styleElement;

                // 为console方法创建代理，确保在预览区域中也能输出到控制台
                const consoleProxy = {
                    log: (...args) => addConsoleMessage(args, 'log'),
                    error: (...args) => addConsoleMessage(args, 'error'),
                    warn: (...args) => addConsoleMessage(args, 'warning'),
                    info: (...args) => addConsoleMessage(args, 'info')
                };

                // 创建一个安全的执行环境
                const executeJS = (code, console) => {
                    // 创建一个沙箱环境执行代码
                    const sandbox = {
                        document: previewArea.ownerDocument,
                        window: window,
                        console: console,
                        setTimeout: setTimeout,
                        clearTimeout: clearTimeout,
                        setInterval: setInterval,
                        clearInterval: clearInterval
                    };

                    // 使用with语句将沙箱对象作为当前作用域
                    with (sandbox) {
                        // 执行代码
                        eval(code);
                    }
                };

                // 执行JavaScript代码
                executeJS(jsContent, consoleProxy);

                // 更新预览状态
                document.getElementById('preview-status').textContent = '已更新';
                document.getElementById('preview-status').className = 'text-xs bg-green-500 px-2 py-0.5 rounded';

                // 显示成功消息
                showStatus('代码已成功运行', 'success');
            } catch (error) {
                // 更新预览状态
                document.getElementById('preview-status').textContent = '运行错误';
                document.getElementById('preview-status').className = 'text-xs bg-red-500 px-2 py-0.5 rounded';

                // 显示错误消息
                const errorMsg = `运行出错: ${error.message} (行: ${error.lineNumber || '未知'})`;
                showStatus(errorMsg, 'error');
                addConsoleMessage([errorMsg], 'error');
                console.error('代码运行错误:', error);
            }
        }

        // 显示状态消息
        function showStatus(message, type) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');

            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            }

            // 3秒后自动隐藏消息
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // 清空所有代码
        function clearAll() {
            htmlEditor.setValue('');
            cssEditor.setValue('');
            jsEditor.setValue('');
            runCode();
            showStatus('已清空所有代码', 'success');
        }

        // 重置为原始代码
        function resetCode() {
            htmlEditor.setValue(originalHtml);
            cssEditor.setValue(originalCss);
            jsEditor.setValue(originalJs);
            runCode();
            showStatus('已重置为初始代码', 'success');
        }

        // 复制代码到剪贴板
        function copyToClipboard(target) {
            let content = '';
            if (target === 'html') {
                content = htmlEditor.getValue();
            } else if (target === 'css') {
                content = cssEditor.getValue();
            } else if (target === 'js') {
                content = jsEditor.getValue();
            }

            navigator.clipboard.writeText(content).then(() => {
                showStatus('代码已复制到剪贴板', 'success');
            }).catch(err => {
                showStatus('复制失败，请手动复制', 'error');
                console.error('复制失败:', err);
            });
        }

        // 触发代码提示
        function showHint(target) {
            if (target === 'html') {
                htmlEditor.showHint();
            } else if (target === 'css') {
                cssEditor.showHint();
            } else if (target === 'js') {
                jsEditor.showHint();
            }
        }

        // 事件监听
        document.getElementById('run-btn').addEventListener('click', runCode);
        document.getElementById('clear-btn').addEventListener('click', clearAll);
        document.getElementById('reset-btn').addEventListener('click', resetCode);
        document.getElementById('clear-console').addEventListener('click', function () {
            const consoleOutput = document.getElementById('console-output');
            consoleOutput.innerHTML = '<div class="console-line text-gray-500">控制台已清空</div>';
        });

        // 为复制按钮添加事件监听
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-target');
                copyToClipboard(target);
            });
        });

        // 为提示按钮添加事件监听
        document.querySelectorAll('.hint-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-target');
                showHint(target);
            });
        });
    </script>
</body>
</html>